<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Resumen Comercial</title>
    <?!= HtmlService.createHtmlOutputFromFile("Estilos").getContent(); ?>
</head>

<body>
    <div class="barraTopComercial">
        <div class="topBarra-izquierda">
            <? var url = getScriptUrl(); ?>
            <a href='<?= url ?>?page=Modulos' class="retornarModulos iconoTopBarra">M√≥dulos</a>
            <h1>Resumen de Cotizaciones</h1>
        </div>
        <div class="topBarra-derecha">
            <button onclick="abrirNuevoPedido()" class="boton-nuevo-pedido">
                ‚ûï Nueva Cotizaci√≥n
            </button>
            <button onclick="debugFrontend()" class="boton-debug" style="background: #8e44aa; color: white; margin-left: 10px;">
                üêõ Debug
            </button>
        </div>
    </div>

    <div class="contenedorModulos">
        <div class="card">
            <h2>Lista de Cotizaciones Registradas</h2>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="filtroPedidos" placeholder="Buscar por c√≥digo, cliente o estado..." 
                       style="padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="overflow-x: auto;">
                <table id="tablaResumen" class="tabla-resumen">
                    <thead>
                        <tr>
                            <th style="width: 150px;">N¬∞ PEDIDO</th>
                            <th style="width: 100px;">FECHA</th>
                            <th style="min-width: 200px;">CLIENTE</th>
                            <th style="width: 120px;">MONTO TOTAL</th>
                            <th style="width: 80px;">MONEDA</th>
                            <th style="width: 120px;">ESTADO</th>
                            <th style="width: 100px;">ACCI√ìN</th>
                            <th style="width: 100px;" class="col-pdf">PDF</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaResumen">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px;">
                                Cargando datos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <p id="loadingText">Cargando...</p>
            <div class="spinner"></div>
        </div>
    </div>

<script>
    // Variables globales
    let datosCotizaciones = [];

    // =============================================================================
    // FUNCIONES UNIFICADAS Y OPTIMIZADAS
    // =============================================================================

    // Configuraci√≥n global (El √≠ndice ROW_INDEX es la √∫ltima columna del array de 8 columnas)
    const CONFIG = {
        columnas: {
            NUM_PEDIDO: 0, FECHA: 1, CLIENTE: 2, MONTO: 3, MONEDA: 4, ESTADO: 5, ROW_INDEX: 7 // 8va columna (√≠ndice 7)
        }
    };

    // Funci√≥n unificada para llamadas a Google Apps Script
    async function ejecutarGAS(funcion, parametros = null) {
        mostrarLoading(true, `Ejecutando ${funcion}...`);
        
        return new Promise((resolve, reject) => {
            const llamada = google.script.run
                .withSuccessHandler(resultado => {
                    mostrarLoading(false);
                    resolve(resultado);
                })
                .withFailureHandler(error => {
                    mostrarLoading(false);
                    console.error(`Error en ${funcion}:`, error);
                    alert(`‚ùå Error al ejecutar ${funcion}: ${error.message || error}`);
                    reject(error);
                });
                
            parametros ? llamada[funcion](parametros) : llamada[funcion]();
        });
    }

    // Funci√≥n unificada para navegaci√≥n
    function navegarA(pagina, parametros = {}) {
        const urlBase = '<?!= getScriptUrl() ?>';
        const parametrosURL = new URLSearchParams(parametros).toString();
        const urlCompleta = `${urlBase}?page=${pagina}${parametrosURL ? '&' + parametrosURL : ''}`;
        
        window.open(urlCompleta, '_blank');
    }

    // =============================================================================
    // FUNCIONES DE INICIALIZACI√ìN Y RENDERIZADO
    // =============================================================================

    document.addEventListener("DOMContentLoaded", function() {
        console.log("üîÑ ResumenComercial.html CARGADO");
        cargarDatosResumen();
        
        // Configurar filtro
        document.getElementById("filtroPedidos").addEventListener("input", filtrarPedidos);
    });

    async function cargarDatosResumen() {
        try {
            // Esta llamada activa la funci√≥n getListaCotizacionesResumen en el backend
            const datos = await ejecutarGAS('getListaCotizacionesResumen');
            datosCotizaciones = datos;
            renderizarTablaResumen(datos);
        } catch (error) {
            console.error("Error cargando datos:", error);
        }
    }

    function renderizarTablaResumen(datos) {
        const tbody = document.getElementById("cuerpoTablaResumen");
        tbody.innerHTML = "";

        if (!datos || datos.length <= 1) {
            tbody.innerHTML = crearFilaVacia("No hay cotizaciones registradas.");
            return;
        }

        // El √≠ndice ROW_INDEX se calcula como la √∫ltima columna del encabezado
        const ROW_INDEX_COL = datos[0].length - 1; 

        // Empezar desde la fila 1 (fila 0 son los encabezados)
        datos.slice(1).forEach((fila) => {
            const numPedido = fila[CONFIG.columnas.NUM_PEDIDO];
            const fecha = fila[CONFIG.columnas.FECHA];
            const cliente = fila[CONFIG.columnas.CLIENTE];
            const monto = parseFloat(fila[CONFIG.columnas.MONTO]) || 0;
            const moneda = fila[CONFIG.columnas.MONEDA];
            const estado = fila[CONFIG.columnas.ESTADO];
            
            // üîë Obtener el valor del Row Index desde la √∫ltima columna
            const rowIndex = fila[ROW_INDEX_COL]; 

            // Validar si es una fila de datos v√°lida
            if (!numPedido || typeof rowIndex !== 'number' || rowIndex < 2) return; 

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${numPedido}</td>
                <td>${fecha}</td>
                <td>${cliente}</td>
                <td class="monto-col">${monto.toFixed(2)}</td>
                <td>${moneda}</td>
                <td>
                    <span class="estado-${estado ? estado.replace(/\s+/g, '-') : 'Desconocido'}">
                        ${estado || 'Desconocido'}
                    </span>
                </td>
                <td>
                    <button onclick="navegarA('Comercial', { editar: '${numPedido}' })" class="btn-editar">
                        ‚úèÔ∏è Editar
                    </button>
                </td>
                <td style="text-align: center;">
                    <button 
                        onclick="generarPDF(${rowIndex})" 
                        class="btn-pdf"
                        data-row="${rowIndex}"
                    >
                        üìÑ PDF
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        });

        console.log("‚úÖ Tabla renderizada con " + (datos.length - 1) + " cotizaciones");
    }
    
    function crearFilaVacia(mensaje) {
        return `
            <tr>
                <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                    ${mensaje}
                </td>
            </tr>
        `;
    }

    // =============================================================================
    // FUNCIONES DE FILTRADO
    // =============================================================================

    function filtrarPedidos() {
        const filtro = document.getElementById("filtroPedidos").value.toLowerCase();
        
        if (!filtro) {
            renderizarTablaResumen(datosCotizaciones);
            return;
        }

        const datosFiltrados = [datosCotizaciones[0]]; // Mantener encabezados
        
        datosCotizaciones.slice(1).forEach(fila => {
            const numPedido = String(fila[CONFIG.columnas.NUM_PEDIDO] || '').toLowerCase();
            const cliente = String(fila[CONFIG.columnas.CLIENTE] || '').toLowerCase();
            const estado = String(fila[CONFIG.columnas.ESTADO] || '').toLowerCase();
            
            if (numPedido.includes(filtro) || cliente.includes(filtro) || estado.includes(filtro)) {
                datosFiltrados.push(fila);
            }
        });
        
        renderizarTablaResumen(datosFiltrados);
    }

    // =============================================================================
    // FUNCIONES DE ACCI√ìN
    // =============================================================================
    
    function abrirNuevoPedido() {
        navegarA('Comercial');
    }

    /**
     * Llama al servidor para generar el PDF del pedido y lo abre.
     * @param {number} rowIndex El √≠ndice de la fila del pedido a procesar (para el detalle completo).
     */
    function generarPDF(rowIndex) {
        if (!confirm(`¬øEst√°s seguro de que deseas generar el PDF para el pedido en la fila ${rowIndex}?`)) {
            return;
        }
        
        // 1. Mostrar mensaje de carga
        const btn = document.querySelector(`.btn-pdf[data-row='${rowIndex}']`);
        if(btn) {
            btn.disabled = true;
            btn.textContent = '‚è≥ Generando...';
        } else {
            alert('Generando PDF...');
        }

        google.script.run
            .withSuccessHandler(function(resultado) {
                if (resultado.success) {
                    // 2. Abrir el PDF en nueva pesta√±a
                    window.open(resultado.pdfUrl, '_blank');
                    alert('‚úÖ PDF generado exitosamente!');
                } else {
                    alert('‚ùå Error al generar PDF: ' + (resultado.error || resultado.message || 'Error desconocido'));
                }
                
                // 3. Restaurar bot√≥n
                if(btn) {
                    btn.disabled = false;
                    btn.textContent = 'üìÑ PDF';
                }
            })
            .withFailureHandler(function(error) {
                alert('‚ùå Error al conectar con el servidor: ' + error.message);
                // 3. Restaurar bot√≥n
                if(btn) {
                    btn.disabled = false;
                    btn.textContent = 'üìÑ PDF';
                }
            })
            .generarYDevolverPDF(rowIndex); // Llama a la funci√≥n de GS
    }

    function debugFrontend() {
        console.log("=== üêõ DEBUG FRONTEND ===");
        console.log("URL actual:", window.location.href);
        console.log("Script URL:", '<?!= getScriptUrl() ?>');
        console.log("Total cotizaciones cargadas (incl. encabezado):", datosCotizaciones.length);
        console.log("=== FIN DEBUG ===");
        
        alert("Debug ejecutado - Revisa la consola del navegador (F12)");
    }

    function mostrarLoading(mostrar, mensaje = "Cargando...") {
        const overlay = document.getElementById("loadingOverlay");
        const texto = document.getElementById("loadingText");
        
        if (overlay && texto) {
            overlay.style.display = mostrar ? "flex" : "none";
            texto.textContent = mensaje;
        }
    }
</script>
</body>
</html>
