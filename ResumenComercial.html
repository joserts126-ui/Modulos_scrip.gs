<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Resumen Comercial</title>
    <?!= HtmlService.createHtmlOutputFromFile("Estilos").getContent(); ?>
</head>

<body>
    <div class="barraTopComercial">
        <div class="topBarra-izquierda">
            <? var url = getScriptUrl(); ?>
            <a href='<?= url ?>?page=Modulos' class="retornarModulos iconoTopBarra">M√≥dulos</a>
            <h1>Resumen de Cotizaciones</h1>
        </div>
        <div class="topBarra-derecha">
            <button onclick="abrirNuevoPedido()" class="boton-nuevo-pedido">
                ‚ûï Nueva Cotizaci√≥n
            </button>
            <button onclick="debugFrontend()" class="boton-debug" style="background: #8e44aa; color: white; margin-left: 10px;">
                üêõ Debug
            </button>
        </div>
    </div>

    <div class="contenedorModulos">
        <div class="card">
            <h2>Lista de Cotizaciones Registradas</h2>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="filtroPedidos" placeholder="Buscar por c√≥digo, cliente o estado..." 
                       style="padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="overflow-x: auto;">
                <table id="tablaResumen" class="tabla-resumen">
                    <thead>
                        <tr>
                            <th style="width: 150px;">N¬∞ PEDIDO</th>
                            <th style="width: 100px;">FECHA</th>
                            <th style="min-width: 200px;">CLIENTE</th>
                            <th style="width: 120px;">MONTO TOTAL</th>
                            <th style="width: 80px;">MONEDA</th>
                            <th style="width: 120px;">ESTADO</th>
                            <th style="width: 100px;">ACCI√ìN</th>
                            <th style="width: 100px;" class="col-pdf">PDF</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaResumen">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px;">
                                Cargando datos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <p id="loadingText">Cargando...</p>
            <div class="spinner"></div>
        </div>
    </div>

<script>
    // Variables globales
    let datosCotizaciones = [];

    // =============================================================================
    // FUNCIONES UNIFICADAS Y OPTIMIZADAS
    // =============================================================================

    // Configuraci√≥n global
    const CONFIG = {
        columnas: {
            NUM_PEDIDO: 0, FECHA: 1, CLIENTE: 2, MONTO: 3, MONEDA: 4, ESTADO: 5
        }
    };

    // Funci√≥n unificada para llamadas a Google Apps Script
    async function ejecutarGAS(funcion, parametros = null) {
        mostrarLoading(true, `Ejecutando ${funcion}...`);
        
        return new Promise((resolve, reject) => {
            const llamada = google.script.run
                .withSuccessHandler(resultado => {
                    mostrarLoading(false);
                    resolve(resultado);
                })
                .withFailureHandler(error => {
                    mostrarLoading(false);
                    console.error(`Error en ${funcion}:`, error);
                    reject(error);
                });
                
            parametros ? llamada[funcion](parametros) : llamada[funcion]();
        });
    }

    // Funci√≥n unificada para navegaci√≥n
    function navegarA(pagina, parametros = {}) {
        const urlBase = '<?!= getScriptUrl() ?>';
        const parametrosURL = new URLSearchParams(parametros).toString();
        const urlCompleta = `${urlBase}?page=${pagina}${parametrosURL ? '&' + parametrosURL : ''}`;
        
        window.open(urlCompleta, '_blank');
    }

    // Funci√≥n unificada para manejo de pedidos
    function manejarPedido(accion, numPedido = null) {
        const acciones = {
            'nuevo': () => navegarA('Comercial'),
            'editar': () => {
                if (!numPedido) return alert('No se ha seleccionado ning√∫n pedido');
                sessionStorage.setItem('pedidoAEditar', numPedido);
                navegarA('Comercial', { editar: numPedido });
            },
            'pdf': async () => {
                if (!numPedido) return alert('No se ha seleccionado ning√∫n pedido');
                
                try {
                    const resultado = await ejecutarGAS('generarPDFCotizacion', numPedido);
                    if (resultado.success) {
                        window.open(resultado.pdfUrl, '_blank');
                        alert('‚úÖ PDF generado exitosamente');
                    } else {
                        alert('‚ùå Error al generar PDF: ' + resultado.message);
                    }
                } catch (error) {
                    alert('‚ùå Error al generar PDF: ' + error.message);
                }
            }
        };
        
        return acciones[accion] ? acciones[accion]() : console.error('Acci√≥n no v√°lida:', accion);
    }

    // =============================================================================
    // FUNCIONES DE INICIALIZACI√ìN Y RENDERIZADO
    // =============================================================================

    document.addEventListener("DOMContentLoaded", function() {
        console.log("üîÑ ResumenComercial.html CARGADO");
        cargarDatosResumen();
        
        // Configurar filtro
        document.getElementById("filtroPedidos").addEventListener("input", filtrarPedidos);
    });

    async function cargarDatosResumen() {
        try {
            const datos = await ejecutarGAS('getListaCotizacionesResumen');
            datosCotizaciones = datos;
            renderizarTablaResumen(datos);
        } catch (error) {
            console.error("Error cargando datos:", error);
        }
    }

function renderizarTablaResumen(datos) {
    const tbody = document.getElementById("cuerpoTablaResumen");
    tbody.innerHTML = "";

    if (!datos || datos.length <= 1) {
        tbody.innerHTML = crearFilaVacia("No hay cotizaciones registradas.");
        return;
    }

    // üîë Paso 1: Determinar el √≠ndice de la columna del Row Index.
    // Es la √∫ltima columna del array (la que acabamos de agregar)
    const ROW_INDEX_COL = datos[0].length - 1; 

    // Empezar desde la fila 1 (fila 0 son los encabezados)
    datos.slice(1).forEach((fila, index) => {
        const numPedido = fila[CONFIG.columnas.NUM_PEDIDO];
        const fecha = fila[CONFIG.columnas.FECHA];
        const cliente = fila[CONFIG.columnas.CLIENTE];
        const monto = parseFloat(fila[CONFIG.columnas.MONTO]) || 0;
        const moneda = fila[CONFIG.columnas.MONEDA];
        const estado = fila[CONFIG.columnas.ESTADO];
        
        // üîë Paso 2: Obtener el valor del Row Index
        const rowIndex = fila[ROW_INDEX_COL]; 

        // Validamos que el √≠ndice sea un n√∫mero v√°lido y mayor a 1 (para evitar el encabezado)
        if (!numPedido || typeof rowIndex !== 'number' || rowIndex < 2) return; 

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${numPedido}</td>
            <td>${fecha}</td>
            <td>${cliente}</td>
            <td class="monto-col">${monto.toFixed(2)}</td>
            <td>${moneda}</td>
            <td>
                <span class="estado-${estado ? estado.replace(/\s+/g, '-') : 'Desconocido'}">
                    ${estado || 'Desconocido'}
                </span>
            </td>
            <td>
                <button onclick="manejarPedido('editar', '${numPedido}')" class="btn-editar">
                    ‚úèÔ∏è Editar
                </button>
            </td>
            <td style="text-align: center;">
                <button 
                    onclick="generarPDF(${rowIndex})" 
                    class="btn-pdf"
                    data-row="${rowIndex}"
                >
                    üìÑ PDF
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });

    console.log("‚úÖ Tabla renderizada con " + (datos.length - 1) + " cotizaciones");
}
    function crearFilaVacia(mensaje) {
        return `
            <tr>
                <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                    ${mensaje}
                </td>
            </tr>
        `;
    }

    // =============================================================================
    // FUNCIONES DE FILTRADO
    // =============================================================================

    function filtrarPedidos() {
        const filtro = document.getElementById("filtroPedidos").value.toLowerCase();
        
        if (!filtro) {
            renderizarTablaResumen(datosCotizaciones);
            return;
        }

        const datosFiltrados = [datosCotizaciones[0]]; // Mantener encabezados
        
        datosCotizaciones.slice(1).forEach(fila => {
            const numPedido = String(fila[CONFIG.columnas.NUM_PEDIDO] || '').toLowerCase();
            const cliente = String(fila[CONFIG.columnas.CLIENTE] || '').toLowerCase();
            const estado = String(fila[CONFIG.columnas.ESTADO] || '').toLowerCase();
            
            if (numPedido.includes(filtro) || cliente.includes(filtro) || estado.includes(filtro)) {
                datosFiltrados.push(fila);
            }
        });
        
        renderizarTablaResumen(datosFiltrados);
    }

    // =============================================================================
    // FUNCIONES DE INTERFAZ
    // =============================================================================

    function abrirNuevoPedido() {
        manejarPedido('nuevo');
    }

    function editarPedidoCorregido(numPedido) {
        manejarPedido('editar', numPedido);
    }

    function debugFrontend() {
        console.log("=== üêõ DEBUG FRONTEND ===");
        console.log("SessionStorage pedidoAEditar:", sessionStorage.getItem('pedidoAEditar'));
        console.log("URL actual:", window.location.href);
        console.log("Script URL:", '<?!= getScriptUrl() ?>');
        console.log("Total cotizaciones:", datosCotizaciones.length - 1);
        console.log("=== FIN DEBUG ===");
        
        alert("Debug ejecutado - Revisa la consola del navegador (F12)");
    }

    function mostrarLoading(mostrar, mensaje = "Cargando...") {
        const overlay = document.getElementById("loadingOverlay");
        const texto = document.getElementById("loadingText");
        
        if (overlay && texto) {
            overlay.style.display = mostrar ? "flex" : "none";
            texto.textContent = mensaje;
        }
    }

    // En tu archivo HTML (ResumenComercial.html)
function cargarResumenConLoading() {
    // Mostrar loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('tablaResumen').style.display = 'none';
    
    // Timeout de seguridad
    const timeoutId = setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        mostrarError('La carga est√° tardando m√°s de lo esperado. Intenta nuevamente.');
    }, 15000); // 15 segundos timeout
    
    google.script.run
        .withSuccessHandler((resultado) => {
            clearTimeout(timeoutId);
            document.getElementById('loading').style.display = 'none';
            
            if (resultado.datos) {
                // Si es paginado
                construirTablaResumen(resultado.datos);
                actualizarPaginacion(resultado);
            } else {
                // Si es normal
                construirTablaResumen(resultado);
            }
        })
        .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            document.getElementById('loading').style.display = 'none';
            mostrarError('Error al cargar el resumen: ' + error);
        })
        .getListaCotizacionesResumen(); // o getResumenPaginado(1, 50)
}
/**
 * Funci√≥n para abrir modal de cotizaci√≥n
 */
function abrirModalCotizacion(ruc, nombreCliente) {
  // Aqu√≠ puedes obtener los contactos y direcciones para seleccionar
  const contacto = prompt("Ingrese el nombre del contacto:", "");
  const contactoInfo = prompt("Ingrese email o tel√©fono del contacto:", "");
  const lugar = prompt("Lugar (ALPAMAYO/GYM/SAN JOSE):", "ALPAMAYO");
  const turno = prompt("Turno:", "MA√ëANA");
  const duracion = prompt("Duraci√≥n:", "1 MES");
  
  if (contacto && contactoInfo && lugar) {
    const datosBase = {
      ruc: ruc,
      nombreCliente: nombreCliente,
      contacto: contacto,
      contactoInfo: contactoInfo,
      lugar: lugar.toUpperCase(),
      turno: turno,
      duracion: duracion,
      items: [] // Aqu√≠ podr√≠as agregar un formulario para los items
    };
    
    // Guardar datos temporalmente y abrir editor de items
    sessionStorage.setItem('datosCotizacionTemp', JSON.stringify(datosBase));
    abrirEditorItems();
  }
}

/**
 * Ejemplo de c√≥mo agregar desde tu tabla de clientes
 */
// Modifica el bot√≥n en tu tabla para incluir la opci√≥n de cotizaci√≥n:
function seleccionarCliente(ruc, nombre) {
  RUC_ACTUAL = ruc;
  NOMBRE_ACTUAL = nombre;
  
  // Podr√≠as agregar un bot√≥n adicional o modificar el existente
  const accion = confirm(`Cliente: ${nombre}\nRUC: ${ruc}\n\n¬øQu√© deseas hacer?\nOK - Ver Detalles\nCancelar - Generar Cotizaci√≥n`);
  
  if (accion) {
    // C√≥digo existente para ver detalles
    document.getElementById("tituloDetalleCliente").textContent = `Gesti√≥n de Cliente: ${nombre} (RUC: ${ruc})`;
    document.getElementById("clienteRUCDisplay").textContent = ruc;
    document.getElementById("clienteNombreInput").value = nombre;
    
    mostrarModal('modalCliente');
    cargarDetallesCliente();
  } else {
    // Nueva funcionalidad: generar cotizaci√≥n
    abrirModalCotizacion(ruc, nombre);
  }
}

/**
 * Llama al servidor para generar el PDF del pedido y lo abre.
 * @param {number} rowIndex El √≠ndice de la fila del pedido a procesar.
 */
function generarPDF(rowIndex) {
    if (!confirm(`¬øEst√°s seguro de que deseas generar el PDF para el pedido en la fila ${rowIndex}?`)) {
        return;
    }
    
    // 1. Mostrar mensaje de carga
    const btn = document.querySelector(`.btn-pdf[data-row='${rowIndex}']`);
    if(btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Generando...';
    } else {
        alert('Generando PDF...');
    }

    google.script.run
        .withSuccessHandler(function(resultado) {
            if (resultado.success) {
                // 2. Abrir el PDF en nueva pesta√±a
                window.open(resultado.pdfUrl, '_blank');
                alert('‚úÖ PDF generado exitosamente!');
            } else {
                alert('‚ùå Error al generar PDF: ' + resultado.error);
            }
            
            // 3. Restaurar bot√≥n
            if(btn) {
                btn.disabled = false;
                btn.textContent = 'üìÑ PDF';
            }
        })
        .withFailureHandler(function(error) {
            alert('‚ùå Error al conectar con el servidor: ' + error.message);
            // 3. Restaurar bot√≥n
            if(btn) {
                btn.disabled = false;
                btn.textContent = 'üìÑ PDF';
            }
        })
        .generarYDevolverPDF(rowIndex); // Llama a la nueva funci√≥n de GS
}

</script>
</body>
</html>